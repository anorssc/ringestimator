<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ring Gold & Diamond Estimator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-xl mx-auto bg-white rounded-2xl shadow-lg p-6 space-y-6">
    <h1 class="text-2xl font-semibold text-slate-900 text-center">
      Ring Gold & Diamond Estimator
    </h1>
    <p class="text-sm text-slate-600 text-center">
      Upload a clear photo of a single ring. You’ll get an estimated breakup of
      <span class="font-medium">gold (grams)</span> and
      <span class="font-medium">diamonds (carats)</span>.
    </p>

    <!-- Upload area -->
    <div
      id="drop-zone"
      class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center cursor-pointer hover:border-slate-400 transition"
    >
      <input
        id="file-input"
        type="file"
        accept="image/*"
        class="hidden"
      />
      <div id="upload-placeholder">
        <p class="text-sm text-slate-600">
          Click to choose an image or drag & drop it here.
        </p>
        <p class="text-xs text-slate-400 mt-1">
          JPG, PNG, HEIC – ideally one ring, shot close-up, no clutter.
        </p>
      </div>
      <div id="preview-container" class="hidden mt-4">
        <img
          id="preview-image"
          alt="Ring preview"
          class="mx-auto max-h-64 rounded-lg object-contain"
        />
        <p class="text-xs text-slate-500 mt-2">
          Preview of the ring image to be analyzed.
        </p>
      </div>
    </div>

    <!-- Optional metadata (you can remove if you want totally image-only) -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
      <div>
        <label class="block text-slate-700 mb-1">Ring size</label>
        <input
          id="ring-size"
          type="text"
          placeholder="e.g. 9"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-slate-500"
        />
      </div>
      <div>
        <label class="block text-slate-700 mb-1">Center stone (ct)</label>
        <input
          id="center-ct"
          type="text"
          placeholder="optional"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-slate-500"
        />
      </div>
      <div>
        <label class="block text-slate-700 mb-1">Known total diamond (ct)</label>
        <input
          id="known-total-ct"
          type="text"
          placeholder="optional"
          class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-slate-500"
        />
      </div>
    </div>

    <!-- Action + status -->
    <div class="flex items-center justify-between gap-4">
      <button
        id="estimate-btn"
        class="flex-1 inline-flex items-center justify-center rounded-xl bg-slate-900 text-white px-4 py-2.5 text-sm font-medium disabled:opacity-60 disabled:cursor-not-allowed hover:bg-slate-800 transition"
        disabled
      >
        <span id="estimate-btn-text">Estimate Gold & Diamonds</span>
        <svg
          id="estimate-btn-spinner"
          class="hidden animate-spin ml-2 h-4 w-4"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-3">
      <h2 class="text-lg font-semibold text-slate-900">Estimated breakup</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="border border-slate-200 rounded-xl p-4">
          <p class="text-xs uppercase tracking-wide text-slate-500 mb-1">
            Gold weight
          </p>
          <p id="gold-result" class="text-xl font-semibold text-slate-900">
            –
          </p>
          <p class="text-xs text-slate-500 mt-1">
            In grams (approximate). Includes full metal weight of shank + head.
          </p>
        </div>
        <div class="border border-slate-200 rounded-xl p-4">
          <p class="text-xs uppercase tracking-wide text-slate-500 mb-1">
            Diamond weight
          </p>
          <p id="diamond-result" class="text-xl font-semibold text-slate-900">
            –
          </p>
          <p class="text-xs text-slate-500 mt-1">
            Total carat weight (approximate) – center + side stones.
          </p>
        </div>
      </div>
      <div class="border border-slate-100 rounded-xl p-4 bg-slate-50">
        <p class="text-xs uppercase tracking-wide text-slate-500 mb-1">
          Notes
        </p>
        <p id="notes" class="text-xs text-slate-600 leading-relaxed">
          –
        </p>
      </div>
    </div>

    <p id="error-msg" class="hidden text-xs text-red-600"></p>
  </div>

  <script>
    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("file-input");
    const previewContainer = document.getElementById("preview-container");
    const previewImage = document.getElementById("preview-image");
    const estimateBtn = document.getElementById("estimate-btn");
    const estimateBtnText = document.getElementById("estimate-btn-text");
    const estimateBtnSpinner = document.getElementById("estimate-btn-spinner");
    const resultsEl = document.getElementById("results");
    const goldResultEl = document.getElementById("gold-result");
    const diamondResultEl = document.getElementById("diamond-result");
    const notesEl = document.getElementById("notes");
    const errorMsgEl = document.getElementById("error-msg");

    function setError(message) {
      errorMsgEl.textContent = message;
      errorMsgEl.classList.remove("hidden");
    }

    function clearError() {
      errorMsgEl.textContent = "";
      errorMsgEl.classList.add("hidden");
    }

    function enableEstimate(enabled) {
      estimateBtn.disabled = !enabled;
    }

    function setLoading(isLoading) {
      if (isLoading) {
        estimateBtnSpinner.classList.remove("hidden");
        estimateBtnText.textContent = "Estimating...";
        estimateBtn.disabled = true;
      } else {
        estimateBtnSpinner.classList.add("hidden");
        estimateBtnText.textContent = "Estimate Gold & Diamonds";
        estimateBtn.disabled = false;
      }
    }

    function handleFile(file) {
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        setError("Please upload a valid image file.");
        return;
      }
      clearError();

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewContainer.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
      enableEstimate(true);
    }

    // Click to open file dialog
    dropZone.addEventListener("click", () => fileInput.click());

    // File chosen via dialog
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      handleFile(file);
    });

    // Drag & drop support
    ;["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    ;["dragenter", "dragover"].forEach((eventName) => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add("border-slate-500", "bg-slate-50");
      });
    });

    ;["dragleave", "drop"].forEach((eventName) => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove("border-slate-500", "bg-slate-50");
      });
    });

    dropZone.addEventListener("drop", (e) => {
      const file = e.dataTransfer.files[0];
      fileInput.files = e.dataTransfer.files;
      handleFile(file);
    });

    // Estimate button
    estimateBtn.addEventListener("click", async () => {
      clearError();

      const file = fileInput.files[0];
      if (!file) {
        setError("Please upload an image first.");
        return;
      }

      const ringSize = document.getElementById("ring-size").value.trim();
      const centerCt = document.getElementById("center-ct").value.trim();
      const knownTotalCt = document
        .getElementById("known-total-ct")
        .value.trim();

      const formData = new FormData();
      formData.append("image", file);
      if (ringSize) formData.append("ringSize", ringSize);
      if (centerCt) formData.append("centerCt", centerCt);
      if (knownTotalCt) formData.append("knownTotalCt", knownTotalCt);

      setLoading(true);
      resultsEl.classList.add("hidden");

      try {
        const res = await fetch("/api/estimate-ring", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          throw new Error("Server error. Please try again.");
        }

        const data = await res.json();
        const {
          gold_grams_min,
          gold_grams_max,
          diamond_ct_min,
          diamond_ct_max,
          notes,
        } = data;

        goldResultEl.textContent =
          gold_grams_min && gold_grams_max
            ? `${gold_grams_min.toFixed(2)} – ${gold_grams_max.toFixed(2)} g`
            : "No estimate";
        diamondResultEl.textContent =
          diamond_ct_min && diamond_ct_max
            ? `${diamond_ct_min.toFixed(2)} – ${diamond_ct_max.toFixed(2)} ct`
            : "No estimate";
        notesEl.textContent = notes || "No additional notes.";

        resultsEl.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        setError(err.message || "Something went wrong. Please try again.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
